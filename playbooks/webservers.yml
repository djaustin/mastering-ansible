---
- hosts: webservers
  gather_facts: no
  tasks: 
    - name: Ensure webserver packages installed
      become: yes
      package: 
        name: "{{ item }}"
        state: present
      with_items:
        - httpd
        - mod_wsgi
        - python-virtualenv
        - python-pip
        - MySQL-python
    - name: Set httpd_can_network_connect flag on and keep it persistent across reboots
      become: yes
      seboolean:
        name: httpd_can_network_connect
        state: yes
        persistent: yes
      notify: restart httpd
    - name: Ensure Apache is started
      become: yes
      service:
        name: httpd
        enabled: yes
        state: started
    - name: Ensure mod_wsgi enabled
      apache2_module:
        state: present
        name: wsgi
      notify: restart httpd
    - name: Ensure application source copied to host
      become: yes
      copy: 
        src: demo/app/
        dest: /var/www/demo
        mode: 0755
      notify: restart httpd
    - name: Ensure virtual host config copied to host
      become: yes
      copy: 
        src: demo/demo.conf
        dest: /etc/httpd/conf.d/
        mode: 0755
      notify: restart httpd
    - name: Ensure virtualenv is set up
      become: yes
      pip:
        requirements: /var/www/demo/requirements.txt
        virtualenv: /var/www/demo/.venv
      notify: restart httpd
      tags: 
        - pip
    - name: Gather existing site configs
      find: 
        path: /etc/httpd/conf.d/
        excludes: demo.conf
      register: other_sites
    - name: Remove other site configs
      file: 
        path: "{{ item }}"
        state: absent
      with_items: "{{ other_sites.files }}"
      notify: restart httpd
  handlers:
    - name: restart httpd
      become: yes
      service:
        name: httpd
        state: restarted        
